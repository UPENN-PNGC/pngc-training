name: Update PNGC Training Courses

on:
  issues:
    types: [labeled]

jobs:
  update-courses:
    if: |
      github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'registration')
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App installation token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: pip install requests

      - name: Run course update script
        run: |
          export GITHUB_TOKEN="${{ steps.app-token.outputs.token }}"
          python .github/scripts/update_courses.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: cpr
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "chore: add or update course in README and folders"
          branch: course-update/${{ github.run_id }}
          title: "Add or update course in README and folders"
          body: |
            Automated course registration update.

            Closes #${{ github.event.issue.number }}

      - name: Notify submitter of approval and PR
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_CREATOR: ${{ github.event.issue.user.login }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          BRANCH_NAME: course-update/${{ github.run_id }}
        run: |
          COMMENT_BODY="Hi @${ISSUE_CREATOR}, your course registration has been **approved**!\n\nA branch (${BRANCH_NAME}) and a pull request have been created: ${PR_URL}\n\nTo add your course materials, you can check out the branch locally:\n\ngit fetch origin ${BRANCH_NAME}\ngit checkout ${BRANCH_NAME}\n\nPlease add your course materials to the new folder and update the PR as needed.\n\n**When you are finished submitting your course materials, please add the 'ready for review' label to this issue.** This will notify the maintainers to review and merge your course.\n\nThank you!"
          curl -s -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments \
            -d "{\"body\": \"${COMMENT_BODY//\"/\\\"}\"}"
